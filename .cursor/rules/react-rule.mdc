// èªè¨€æª”æ¡ˆçµæ§‹
interface Messages {
  'app.title': string;
  'nav.home': string;
  'nav.about': string;
  'nav.contact': string;
  'user.greeting': string;
  'user.profile.edit': string;
  'form.validation.required': string;
  'form.validation.email': string;
  'button.save': string;
  'button.cancel': string;
  'error.network': string;
  'success.saved': string;
}

// èªè¨€è³‡æº
const messages: Record<string, Messages> = {
  'zh-TW': {
    'app.title': 'React æ‡‰ç”¨ç¨‹å¼',
    'nav.home': 'é¦–é ',
    'nav.about': 'é—œæ–¼æˆ‘å€‘',
    'nav.contact': 'è¯çµ¡æˆ‘å€‘',
    'user.greeting': 'æ‚¨å¥½ï¼Œ{name}ï¼',
    'user.profile.edit': 'ç·¨è¼¯å€‹äººè³‡æ–™',
    'form.validation.required': 'æ­¤æ¬„ä½ç‚ºå¿…å¡«',
    'form.validation.email': 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€',
    'button.save': 'å„²å­˜',
    'button.cancel': 'å–æ¶ˆ',
    'error.network': 'ç¶²è·¯é€£ç·šéŒ¯èª¤',
    'success.saved': 'å„²å­˜æˆåŠŸ',
  },
  'en-US': {
    'app.title': 'React Application',
    'nav.home': 'Home',
    'nav.about': 'About',
    'nav.contact': 'Contact',
    'user.greeting': 'Hello, {name}!',
    'user.profile.edit': 'Edit Profile',
    'form.validation.required': 'This field is required',
    'form.validation.email': 'Please enter a valid email address',
    'button.save': 'Save',
    'button.cancel': 'Cancel',
    'error.network': 'Network connection error',
    'success.saved': 'Saved successfully',
  },
  'ja-JP': {
    'app.title': 'Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
    'nav.home': 'ãƒ›ãƒ¼ãƒ ',
    'nav.about': 'ã«ã¤ã„ã¦',
    'nav.contact': 'ãŠå•ã„åˆã‚ã›',
    'user.greeting': 'ã“ã‚“ã«ã¡ã¯ã€{name}ã•ã‚“ï¼',
    'user.profile.edit': 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†',
    'form.validation.required': 'ã“ã®é …ç›®ã¯å¿…é ˆã§ã™',
    'form.validation.email': 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
    'button.save': 'ä¿å­˜',
    'button.cancel': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    'error.network': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼',
    'success.saved': 'ä¿å­˜ã•ã‚Œã¾ã—ãŸ',
  },
};

// âœ“ åœ‹éš›åŒ– Context å’Œ Hook
interface I18nContextValue {
  locale: string;
  setLocale: (locale: string) => void;
  availableLocales: Array<{ code: string; name: string; flag: string }>;
  isRTL: boolean;
}

const I18nContext = createContext<I18nContextValue | null>(null);

const useI18n = () => {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within I18nProvider');
  }
  return context;
};

const I18nProvider = ({ children }: { children: ReactNode }) => {
  const [locale, setLocale] = useState(() => {
    // å„ªå…ˆé †åºï¼šlocalStorage > ç€è¦½å™¨èªè¨€ > é è¨­èªè¨€
    const savedLocale = localStorage.getItem('app-locale');
    if (savedLocale && messages[savedLocale]) {
      return savedLocale;
    }
    
    const browserLocale = navigator.language;
    if (messages[browserLocale]) {
      return browserLocale;
    }
    
    // å˜—è©¦åŒ¹é…èªè¨€ä»£ç¢¼ï¼ˆå¿½ç•¥åœ°å€ï¼‰
    const languageCode = browserLocale.split('-')[0];
    const matchingLocale = Object.keys(messages).find(key => key.startsWith(languageCode));
    
    return matchingLocale || 'zh-TW';
  });
  
  const availableLocales = [
    { code: 'zh-TW', name: 'ç¹é«”ä¸­æ–‡', flag: 'ğŸ‡¹ğŸ‡¼' },
    { code: 'en-US', name: 'English', flag: 'ğŸ‡ºğŸ‡¸' },
    { code: 'ja-JP', name: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ' },
  ];
  
  const isRTL = ['ar', 'he', 'fa'].includes(locale.split('-')[0]);
  
  const handleSetLocale = useCallback((newLocale: string) => {
    setLocale(newLocale);
    localStorage.setItem('app-locale', newLocale);
    
    // æ›´æ–° HTML lang å±¬æ€§
    document.documentElement.lang = newLocale;
    document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
  }, [isRTL]);
  
  useEffect(() => {
    document.documentElement.lang = locale;
    document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
  }, [locale, isRTL]);
  
  return (
    <I18nContext.Provider
      value={{
        locale,
        setLocale: handleSetLocale,
        availableLocales,
        isRTL,
      }}
    >
      <IntlProvider
        locale={locale}
        messages={messages[locale]}
        defaultLocale="zh-TW"
        onError={(error) => {
          if (process.env.NODE_ENV === 'development') {
            console.warn('React Intl Error:', error);
          }
        }}
      >
        {children}
      </IntlProvider>
    </I18nContext.Provider>
  );
};

// âœ“ èªè¨€åˆ‡æ›å™¨çµ„ä»¶
const LanguageSwitcher = () => {
  const { locale, setLocale, availableLocales } = useI18n();
  
  return (
    <select
      value={locale}
      onChange={(e) => setLocale(e.target.value)}
      aria-label="é¸æ“‡èªè¨€"
      className="language-switcher"
    >
      {availableLocales.map((lang) => (
        <option key={lang.code} value={lang.code}>
          {lang.flag} {lang.name}
        </option>
      ))}
    </select>
  );
};

// âœ“ åœ‹éš›åŒ–è¡¨å–®çµ„ä»¶
const InternationalizedForm = () => {
  const intl = useIntl();
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    birthDate: '',
    salary: 0,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  
  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    
    if (!formData.name.trim()) {
      newErrors.name = intl.formatMessage({ id: 'form.validation.required' });
    }
    
    if (!formData.email.trim()) {
      newErrors.email = intl.formatMessage({ id: 'form.validation.required' });
    } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
      newErrors.email = intl.formatMessage({ id: 'form.validation.email' });
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };
  
  const handleSubmit = (e: FormEvent) => {
    e.preventDefault();
    if (validateForm()) {
      console.log('Form submitted:', formData);
    }
  };
  
  return (
    <form onSubmit={handleSubmit} className="intl-form">
      <h2>
        <FormattedMessage id="user.profile.edit" />
      </h2>
      
      <div className="form-group">
        <label htmlFor="name">
          <FormattedMessage id="form.field.name" defaultMessage="å§“å" />
          <span aria-label={intl.formatMessage({ id: 'form.required.indicator' })}>*</span>
        </label>
        <input
          id="name"
          type="text"
          value={formData.name}
          onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
          placeholder={intl.formatMessage({ 
            id: 'form.placeholder.name', 
            defaultMessage: 'è«‹è¼¸å…¥æ‚¨çš„å§“å' 
          })}
          aria-invalid={!!errors.name}
          aria-describedby={errors.name ? 'name-error' : undefined}
        />
        {errors.name && (
          <div id="name-error" role="alert" className="error-message">
            {errors.name}
          </div>
        )}
      </div>
      
      <div className="form-group">
        <label htmlFor="email">
          <FormattedMessage id="form.field.email" defaultMessage="é›»å­éƒµä»¶" />
          <span aria-label={intl.formatMessage({ id: 'form.required.indicator' })}>*</span>
        </label>
        <input
          id="email"
          type="email"
          value={formData.email}
          onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
          placeholder={intl.formatMessage({ 
            id: 'form.placeholder.email', 
            defaultMessage: 'è«‹è¼¸å…¥é›»å­éƒµä»¶åœ°å€' 
          })}
          aria-invalid={!!errors.email}
          aria-describedby={errors.email ? 'email-error' : undefined}
        />
        {errors.email && (
          <div id="email-error" role="alert" className="error-message">
            {errors.email}
          </div>
        )}
      </div>
      
      <div className="form-group">
        <label htmlFor="birthDate">
          <FormattedMessage id="form.field.birthDate" defaultMessage="å‡ºç”Ÿæ—¥æœŸ" />
        </label>
        <input
          id="birthDate"
          type="date"
          value={formData.birthDate}
          onChange={(e) => setFormData(prev => ({ ...prev, birthDate: e.target.value }))}
        />
        {formData.birthDate && (
          <div className="field-preview">
            <FormattedMessage id="form.preview.birthDate" defaultMessage="é¡¯ç¤ºç‚º: " />
            <FormattedDate
              value={new Date(formData.birthDate)}
              year="numeric"
              month="long"
              day="numeric"
            />
          </div>
        )}
      </div>
      
      <div className="form-group">
        <label htmlFor="salary">
          <FormattedMessage id="form.field.salary" defaultMessage="è–ªè³‡" />
        </label>
        <input
          id="salary"
          type="number"
          value={formData.salary}
          onChange={(e) => setFormData(prev => ({ ...prev, salary: Number(e.target.value) }))}
        />
        {formData.salary > 0 && (
          <div className="field-preview">
            <FormattedMessage id="form.preview.salary" defaultMessage="é¡¯ç¤ºç‚º: " />
            <FormattedNumber
              value={formData.salary}
              style="currency"
              currency="TWD"
            />
          </div>
        )}
      </div>
      
      <div className="form-actions">
        <button type="submit" className="btn-primary">
          <FormattedMessage id="button.save" />
        </button>
        <button type="button" className="btn-secondary">
          <FormattedMessage id="button.cancel" />
        </button>
      </div>
    </form>
  );
};

// ... existing code ...
const createCSPHeader = (config: CSPConfig, isDevelopment = false): string => {
  const directives = Object.entries(config)
    .map(([key, values]) => {
      const directive = key.replace(/([A-Z])/g, '-$1').toLowerCase();
      return `${directive} ${values.join(' ')}`;
    })
    .join('; ');
  // é–‹ç™¼ç’°å¢ƒå…è¨± unsafe-eval ç”¨æ–¼ HMR
  if (isDevelopment) {
    return directives.replace(
      'script-src',
      "script-src 'unsafe-eval'"
    );
  }
  return directives;
};

// âœ“ CSP å°æ¯”ç¯„ä¾‹

// âœ“ æ­£ä¾‹
const csp = createCSPHeader({
  defaultSrc: ["'self'"],
  scriptSrc: ["'self'", "https://trusted.cdn.com"],
  styleSrc: ["'self'", "https://fonts.googleapis.com"],
  imgSrc: ["'self'", "data:"],
  connectSrc: ["'self'"],
  fontSrc: ["'self'", "https://fonts.gstatic.com"],
  objectSrc: ["'none'"],
  mediaSrc: ["'self'"],
  frameSrc: ["'none'"],
});

// âœ— åä¾‹
const cspBad = createCSPHeader({
  defaultSrc: ["*"],
  scriptSrc: ["*"],
  styleSrc: ["*"],
  imgSrc: ["*"],
  connectSrc: ["*"],
  fontSrc: ["*"],
  objectSrc: ["*"],
  mediaSrc: ["*"],
  frameSrc: ["*"],
});
// å¤±æ•—åŸå› ï¼šå…è¨±æ‰€æœ‰ä¾†æºï¼Œç„¡æ³•é˜²æ­¢ XSS èˆ‡è³‡æºæ³¨å…¥æ”»æ“Šã€‚

// ...
// åœ–åƒã€å½±ç‰‡èˆ‡åª’é«”
// lazy loadingã€AVIF/WebPã€canvas/WebGL æ•´åˆ
const OptimizedImage = ({ src, alt, width, height }) => (
  <picture>
    <source srcSet={src.replace('.jpg', '.avif')} type="image/avif" />
    <source srcSet={src.replace('.jpg', '.webp')} type="image/webp" />
    <img src={src} alt={alt} loading="lazy" width={width} height={height} />
  </picture>
);

// WebGL æ•´åˆ
import { useRef, useEffect } from 'react';
const WebGLCanvas = () => {
  const canvasRef = useRef(null);
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const gl = canvas.getContext('webgl');
    if (!gl) return;
    // WebGL åˆå§‹åŒ–èˆ‡ç¹ªè£½...
  }, []);
  return <canvas ref={canvasRef} width={640} height={480} />;
};

// Progressive Web App
// Service Workerã€é›¢ç·šç­–ç•¥ã€èƒŒæ™¯åŒæ­¥
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(
      reg => console.log('SW registered', reg),
      err => console.error('SW registration failed', err)
    );
  });
}

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(response => response || fetch(event.request))
  );
});

self.addEventListener('sync', event => {
  if (event.tag === 'sync-comments') {
    event.waitUntil(syncComments());
  }
});

// Server Components èˆ‡é‚Šç·£æ¸²æŸ“
// React æœå‹™ç«¯å…ƒä»¶åŸç†ã€RSC + Bunã€Edge Runtime secure fetch
export default function Page() {
  const data = fetchDataFromDB();
  return <div>{data.title}</div>;
}

export async function edgeHandler(request) {
  const res = await fetch('https://api.example.com/data', {
    headers: { 'Authorization': `Bearer ${process.env.API_TOKEN}` },
    cache: 'no-store',
  });
  return new Response(await res.text());
}

// MobXï¼Zustandï¼Redux Toolkit å°ˆç« 
// æ¯”è¼ƒé¸å‹ã€æ•ˆèƒ½é™·é˜±èˆ‡æœ€ä½³å¯¦è¸
import create from 'zustand';
const useStore = create(set => ({
  count: 0,
  inc: () => set(state => ({ count: state.count + 1 })),
}));

import { configureStore, createSlice } from '@reduxjs/toolkit';
const counterSlice = createSlice({
  name: 'counter',
  initialState: 0,
  reducers: {
    increment: state => state + 1,
    decrement: state => state - 1,
  },
});
const store = configureStore({ reducer: { counter: counterSlice.reducer } });
// æ­£ä¾‹ï¼šé¸æ“‡ Zustand è™•ç†æœ¬åœ° UI ç‹€æ…‹ï¼ŒRedux Toolkit è™•ç†å…¨åŸŸæ¥­å‹™ç‹€æ…‹ã€‚
// åä¾‹ï¼šMobX ç”¨æ–¼å¤§å‹å¤šäººå”ä½œå°ˆæ¡ˆï¼Œå°è‡´ç‹€æ…‹è¿½è¹¤å›°é›£èˆ‡æ•ˆèƒ½ç“¶é ¸ã€‚
// å¤±æ•—åŸå› ï¼šMobX çš„éš±å¼ä¾è³´è¿½è¹¤åœ¨å¤§å‹å°ˆæ¡ˆä¸­æ˜“å‡ºç¾ä¸å¯é æœŸçš„é‡æ¸²æŸ“ã€‚

// Monorepo èˆ‡æ¨¡çµ„åŒ–
// Turborepo 2ã€Nxã€pnpm workspacesã€åŒ…è£åº«è¨­è¨ˆ
// package.json
// {
//   "name": "my-monorepo",
//   "private": true,
//   "workspaces": [
//     "packages/*",
//     "apps/*"
//   ]
// }

// CI/CD èˆ‡éƒ¨ç½²
// Vite + Dockerã€å¤šç’°å¢ƒé…ç½®ã€GitHub Actionsã€è‡ªå‹•åŒ–å›æ­¸æ¸¬è©¦
// .github/workflows/ci.yml
// name: CI
// on: [push, pull_request]
// jobs:
//   build:
//     runs-on: ubuntu-latest
//     steps:
//       - uses: actions/checkout@v3
//       - uses: pnpm/action-setup@v2
//         with:
//           version: 8
//       - run: pnpm install
//       - run: pnpm build
//       - run: pnpm test

// å¯è§€æ¸¬æ€§èˆ‡æ—¥èªŒ
// OpenTelemetryã€Sentryã€Logflareã€Edge è¿½è¹¤
import * as Sentry from '@sentry/react';
Sentry.init({
  dsn: 'https://xxx@sentry.io/123',
  integrations: [new Sentry.BrowserTracing()],
  tracesSampleRate: 1.0,
});

// å‡ç´šèˆ‡é·ç§»æŒ‡å—
// React 18 â†’ 19ã€Legacy Contextã€Class Component å…±å­˜ç­–ç•¥
// 1. æª¢æŸ¥æ‰€æœ‰ç¬¬ä¸‰æ–¹å¥—ä»¶ç›¸å®¹æ€§
// 2. é€æ­¥æ›¿æ›èˆŠ APIï¼ˆå¦‚ legacy contextã€UNSAFE_ å‰ç¶´æ–¹æ³•ï¼‰
// 3. ä½¿ç”¨ codemod å·¥å…·è‡ªå‹•è½‰æ›
// npx react-codemod update-react-19

// é™„éŒ„
// è©å½™è¡¨ã€å»¶ä¼¸é–±è®€ã€å¸¸è¦‹å•ç­”
// RSCï¼šReact Server Components
// Suspenseï¼šReact ä¸²æµèˆ‡ç•°æ­¥é‚Šç•Œ
// Transitionï¼šReact 19 ä¸¦ç™¼ç‹€æ…‹åˆ‡æ› API
// Zodï¼šTypeScript å‹åˆ¥é©—è­‰å‡½å¼åº«
// MSWï¼šMock Service Workerï¼ŒAPI æ¸¬è©¦å·¥å…·
// ...
// Call-To-Action
// ç«‹å³ç”¨æœ¬æ‰‹å†Šçš„ã€Œè‡ªæˆ‘æª¢æŸ¥æ¸…å–®ã€å¯©æ ¸ä½ çš„ç¾æœ‰å°ˆæ¡ˆï¼Œæ‰¾å‡ºå¯å„ªåŒ–çš„æ¶æ§‹ã€æ•ˆèƒ½èˆ‡å®‰å…¨ç’°ç¯€ã€‚å°‡æ¯ä¸€é …åæ€ç›’å•é¡Œå¯¦éš›æ¼”ç·´ï¼Œä¸¦å°‡æœ€ä½³å¯¦è¸è½å¯¦æ–¼æ—¥å¸¸é–‹ç™¼æµç¨‹ã€‚å”¯æœ‰æŒçºŒæª¢æŸ¥èˆ‡ç²¾é€²ï¼Œæ‰èƒ½çœŸæ­£æ™‰å‡ React æ¶æ§‹å¸«ä¹‹è·¯ï¼